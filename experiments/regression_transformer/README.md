# Regression Transformer

## Installation

Installation instructions can be found at: https://github.com/IBM/regression-transformer.
We revise the original Regression Transformer to be compliant with PyTorch 2.x and HuggingFace >=4.38. (Note: Update to code requires torch version >= 1.4)

Also, `boom` must also be installed of course. 

## Usage
### Data Generation
All OOD datasets can be generated with the Jupyter notebook available at [src/OOD_data/make_data.ipynb](/experiments/regression_transformer/src/OOD_data/make_data.ipynb).  

### Training from Scratch
Training a Regression Transformer model without any pretraining can be performed by running the relevant script in [src/experiments/train/selfies/](/experiments/regression_transformer/src/experiments/train/selfies/). For a brand new training run to predict
property, _{prop_name}_, without using the IBM pretrained QED model, run `./{prop_name}-SELFIES-OOD-scratch.sh`.

Continuing a training run from an existing model checkpoint can be performed by updating the '--model' flag in the shell script and running `./{prop_name}-SELFIES-OOD-scratch_continue.sh`


### Training from IBM Pretrained Models
First, download the pretrained Regression Transformer model checkpoints (pytorch_model.bin) from the [IBM Box folder](https://ibm.ent.box.com/s/kijawq3rf4191bbcyflsxx7kp9m74jnx/folder/188528200899) and save it
it in [src/pretrained_models/qed_IBM_pretrained/](/experiments/regression_transformer/src/pretrained_models/qed_IBM_pretrained).

Then, model training can be performed by running the relevant script in [src/experiments/train/selfies/](/experiments/regression_transformer/src/experiments/train/selfies/). For a new training run to predict property _{prop_name}_ without using the IBM pretrained QED model, run `./{prop_name}-SELFIES-OOD-pretrained.sh`

Continuing a training run from an existing model checkpoint can be performed by updating the '--model' flag in the shell script and running `./{prop_name}-SELFIES-OOD-pretrained_continue.sh`

### Evaluation
Model outputs can be generated by running the relevant shell scripts in [src/experiments/eval/](/experiments/regression_transformer/src/experiments/eval/). The predictions for property, _{prop_name}_,
can be output from scratch models by running `{prop_name}-SELFIES-scratch-iid_eval.sh` for the IID test set, and `{prop_name}-SELFIES-scratch-ood_eval.sh` for the OOD test set. 

Similarly, the outputs from pretrained models (models initialized by loading the IBM QED model) can be generated by running `{prop_name}-SELFIES-pretrained-iid_eval.sh` for the IID test set, and `{prop_name}-SELFIES-pretrained-ood_eval.sh` for the OOD test set.

## Results

### 10K CSD dataset-Pretrained
<p align="center">
<img src="/experiments/regression_transformer/results/plots/Pretrained_density_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_hof_parity_plot.png" width="300" /> 
</p>

### 10K CSD dataset-Scratch
<p align="center">
<img src="/experiments/regression_transformer/results/plots/Scratch_density_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Scratch_hof_parity_plot.png" width="300" /> 
</p>

### QM9 Properties- Scratch
<p align="center">
<img src="/experiments/regression_transformer/results/plots/Scratch_qm9_alpha_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Scratch_qm9_cv_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Scratch_qm9_homo_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Scratch_qm9_lumo_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Scratch_qm9_r2_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Scratch_qm9_zpve_parity_plot.png" width="300" /> 
<p align="center">

### QM9 Properties- Pretrained
<p align="center">
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_alpha_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_cv_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_gap_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_homo_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_lumo_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_mu_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_r2_parity_plot.png" width="300" /> 
<img src="/experiments/regression_transformer/results/plots/Pretrained_qm9_zpve_parity_plot.png" width="300" /> 

<p align="center">
